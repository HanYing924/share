From 9c6ac9a09e77204aead7f03a8680e82bdec2c42a Mon Sep 17 00:00:00 2001
From: Jie Chen <jie.a.chen@intel.com>
Date: Thu, 13 Feb 2014 16:20:34 +0800
Subject: [PATCH] Enable x64 build

---
 build/android/envsetup_functions.sh |   13 ++++++++++++-
 build/common.gypi                   |    6 ++++++
 build/config/android/config.gni     |    2 ++
 build/config/sysroot.gni            |    2 ++
 build/toolchain/android/BUILD.gn    |   13 +++++++++++++
 5 files changed, 35 insertions(+), 1 deletion(-)

diff --git a/build/android/envsetup_functions.sh b/build/android/envsetup_functions.sh
index af24116..756b743 100755
--- a/build/android/envsetup_functions.sh
+++ b/build/android/envsetup_functions.sh
@@ -25,6 +25,7 @@ common_check_toolchain() {
 # based on CHROME_SRC and ANDROID_TOOLCHAIN, along with DEFINES for GYP_DEFINES.
 ################################################################################
 common_vars_defines() {
+  toolchain_version="4.6"
   # Set toolchain path according to product architecture.
   case "${TARGET_ARCH}" in
     "arm")
@@ -33,6 +34,10 @@ common_vars_defines() {
     "x86")
       toolchain_arch="x86"
       ;;
+    "x64")
+      toolchain_arch="x86_64"
+      toolchain_version="4.8"
+      ;;
     "mips")
       toolchain_arch="mipsel-linux-android"
       ;;
@@ -43,7 +48,6 @@ common_vars_defines() {
       ;;
   esac
 
-  toolchain_version="4.6"
   toolchain_target=$(basename \
     ${ANDROID_NDK_ROOT}/toolchains/${toolchain_arch}-${toolchain_version})
   toolchain_path="${ANDROID_NDK_ROOT}/toolchains/${toolchain_target}"\
@@ -125,6 +129,13 @@ ${ANDROID_SDK_BUILD_TOOLS_VERSION}
       DEFINES+=" host_arch=${host_arch}"
       DEFINES+=" target_arch=ia32"
       ;;
+    "x64")
+      DEFINES+=" use_libffmpeg=0"
+      host_arch=$(uname -m | sed -e \
+        's/i.86/ia32/;s/x86_64/x64/;s/amd64/x64/;s/arm.*/arm/;s/i86pc/ia32/')
+      DEFINES+=" host_arch=${host_arch}"
+      DEFINES+=" target_arch=x64"
+      ;;
     "mips")
       DEFINES+=" target_arch=mipsel"
       DEFINES+=" mips_arch_variant=mips32r1"
diff --git a/build/common.gypi b/build/common.gypi
index e1bab1e3e..3252c4e 100644
--- a/build/common.gypi
+++ b/build/common.gypi
@@ -1389,6 +1389,12 @@
               'android_ndk_sysroot%': '<(android_ndk_root)/platforms/android-14/arch-x86',
               'android_toolchain%': '<(android_ndk_root)/toolchains/x86-4.6/prebuilt/<(host_os)-<(android_host_arch)/bin',
             }],
+            ['target_arch == "x64"', {
+              'android_app_abi%': 'x86_64',
+              'android_gdbserver%': '<(android_ndk_root)/prebuilt/android-x86_64/gdbserver/gdbserver',
+              'android_ndk_sysroot%': '<(android_ndk_root)/platforms/android-14/arch-x86_64',
+              'android_toolchain%': '<(android_ndk_root)/toolchains/x86_64-4.8/prebuilt/<(host_os)-<(android_host_arch)/bin',
+            }],
             ['target_arch=="arm"', {
               'conditions': [
                 ['arm_version<7', {
diff --git a/build/config/android/config.gni b/build/config/android/config.gni
index 9fc6c27..c05de24 100644
--- a/build/config/android/config.gni
+++ b/build/config/android/config.gni
@@ -40,6 +40,8 @@ if (is_android) {
 
   if (cpu_arch == "x86") {
     android_app_abi = "x86"
+  } else if (cpu_arch == "x64") {
+    android_app_abi = "x86_64"
   } else if (cpu_arch == "arm") {
     import("//build/config/arm.gni")
     if (arm_version < 7) {
diff --git a/build/config/sysroot.gni b/build/config/sysroot.gni
index 4d3958a..036f610 100644
--- a/build/config/sysroot.gni
+++ b/build/config/sysroot.gni
@@ -10,6 +10,8 @@ if (is_android) {
   if (!is_android_webview_build) {
     if (cpu_arch == "x86") {
       sysroot = "$android_ndk_root/platforms/android-14/arch-x86"
+    } else if (cpu_arch == "x64") {
+      sysroot = "$android_ndk_root/platforms/android-19/arch-x86_64"
     } else if (cpu_arch == "arm") {
       sysroot = "$android_ndk_root/platforms/android-14/arch-arm"
     } else if (cpu_arch == "mipsel") {
diff --git a/build/toolchain/android/BUILD.gn b/build/toolchain/android/BUILD.gn
index 8f84f69..f0e1842 100644
--- a/build/toolchain/android/BUILD.gn
+++ b/build/toolchain/android/BUILD.gn
@@ -28,6 +28,8 @@ if (is_gyp) {
     # Find the compiler for GYP for non-Clang Android.
     if (cpu_arch == "x86") {
       android_toolchain_arch = "x86-4.6"
+    } else if (cpu_arch == "x64") {
+      android_toolchain_arch = "x86_64-4.8"
     } else if (cpu_arch == "arm") {
       android_toolchain_arch = "arm-linux-androideabi-4.6"
     } else if (cpu_arch == "mipsel") {
@@ -85,6 +87,17 @@ gcc_toolchain("x86") {
   toolchain_os = "android"
 }
 
+gcc_toolchain("x64") {
+  prefix = "$android_ndk_root/toolchains/x86_64-4.8/prebuilt/$build_os-$android_host_arch/bin/x86_64-linux-android-"
+  cc  = prefix + "gcc"
+  cxx = prefix + "g++"
+  ar  = prefix + "ar"
+  ld  = cxx
+
+  toolchain_cpu_arch = "x64"
+  toolchain_os = "android"
+}
+
 gcc_toolchain("arm") {
   prefix = "$android_ndk_root/toolchains/arm-linux-androideabi-4.6/prebuilt/$build_os-$android_host_arch/bin/arm-linux-androideabi-"
   cc  = prefix + "gcc"
-- 
1.7.9.5

