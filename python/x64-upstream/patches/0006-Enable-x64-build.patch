From e38f5d0e922fbcb8dca5369de9d29653539d6380 Mon Sep 17 00:00:00 2001
From: Yang Gu <yang.gu@intel.com>
Date: Thu, 20 Feb 2014 13:16:56 +0800
Subject: [PATCH 6/8] Enable x64 build

---
 build/common.gypi                | 38 ++++++++++++++++++++++++++++++++++++--
 build/config/android/config.gni  |  2 ++
 build/config/sysroot.gni         |  2 ++
 build/toolchain/android/BUILD.gn | 13 +++++++++++++
 4 files changed, 53 insertions(+), 2 deletions(-)

diff --git a/build/common.gypi b/build/common.gypi
index fca190c..131af14 100644
--- a/build/common.gypi
+++ b/build/common.gypi
@@ -1434,6 +1434,12 @@
               'android_ndk_sysroot%': '<(android_ndk_root)/platforms/android-14/arch-x86',
               'android_toolchain%': '<(android_ndk_root)/toolchains/x86-4.6/prebuilt/<(host_os)-<(android_host_arch)/bin',
             }],
+            ['target_arch == "x64"', {
+              'android_app_abi%': 'x86_64',
+              'android_gdbserver%': '<(android_ndk_root)/prebuilt/android-x86_64/gdbserver/gdbserver',
+              'android_ndk_sysroot%': '<(android_ndk_root)/platforms/android-19/arch-x86_64',
+              'android_toolchain%': '<(android_ndk_root)/toolchains/x86_64-4.8/prebuilt/<(host_os)-<(android_host_arch)/bin',
+            }],
             ['target_arch=="arm"', {
               'conditions': [
                 ['arm_version<7', {
@@ -3269,6 +3275,35 @@
               }],
             ],
           }],
+          ['target_arch=="x64"', {
+            'target_conditions': [
+              ['_toolset=="target"', {
+                'asflags': [
+                  # FIXME: Do we really need this?
+                  '-64',
+                ],
+                'conditions': [
+                  # Use gold linker for Android x64 target.
+                  ['OS=="android"', {
+                    'cflags': [
+                      '-fuse-ld=gold',
+                      '-Wno-unused-local-typedefs',
+                    ],
+                    'ldflags': [
+                      '-fuse-ld=gold',
+                    ],
+                  }],
+                ],
+                'cflags': [
+                  '-m64',
+                  '-march=x86-64',
+                ],
+                'ldflags': [
+                  '-m64',
+                ],
+              }],
+            ],
+          }],
           ['target_arch=="arm"', {
             'target_conditions': [
               ['_toolset=="target"', {
@@ -4001,7 +4036,7 @@
                   '-L<(android_stlport_libs_dir)',
                 ],
               }],
-              ['target_arch=="ia32"', {
+              ['target_arch=="ia32" or target_arch=="x64"', {
                 # The x86 toolchain currently has problems with stack-protector.
                 'cflags!': [
                   '-fstack-protector',
@@ -4015,7 +4050,6 @@
               ['_type=="executable"', {
                 'ldflags': [
                   '-Bdynamic',
-                  '-Wl,-dynamic-linker,/system/bin/linker',
                   '-Wl,--gc-sections',
                   '-Wl,-z,nocopyreloc',
                   # crtbegin_dynamic.o should be the last item in ldflags.
diff --git a/build/config/android/config.gni b/build/config/android/config.gni
index 6a9080b..e892f53 100644
--- a/build/config/android/config.gni
+++ b/build/config/android/config.gni
@@ -41,6 +41,8 @@ if (is_android) {
 
   if (cpu_arch == "x86") {
     android_app_abi = "x86"
+  } else if (cpu_arch == "x64") {
+    android_app_abi = "x86_64"
   } else if (cpu_arch == "arm") {
     import("//build/config/arm.gni")
     if (arm_version < 7) {
diff --git a/build/config/sysroot.gni b/build/config/sysroot.gni
index cecc1ea..5be7c56 100644
--- a/build/config/sysroot.gni
+++ b/build/config/sysroot.gni
@@ -10,6 +10,8 @@ if (is_android) {
   if (!is_android_webview_build) {
     if (cpu_arch == "x86") {
       sysroot = "$android_ndk_root/platforms/android-14/arch-x86"
+    } else if (cpu_arch == "x64") {
+      sysroot = "$android_ndk_root/platforms/android-19/arch-x86_64"
     } else if (cpu_arch == "arm") {
       sysroot = "$android_ndk_root/platforms/android-14/arch-arm"
     } else if (cpu_arch == "mipsel") {
diff --git a/build/toolchain/android/BUILD.gn b/build/toolchain/android/BUILD.gn
index 8f84f69..f0e1842 100644
--- a/build/toolchain/android/BUILD.gn
+++ b/build/toolchain/android/BUILD.gn
@@ -28,6 +28,8 @@ if (is_gyp) {
     # Find the compiler for GYP for non-Clang Android.
     if (cpu_arch == "x86") {
       android_toolchain_arch = "x86-4.6"
+    } else if (cpu_arch == "x64") {
+      android_toolchain_arch = "x86_64-4.8"
     } else if (cpu_arch == "arm") {
       android_toolchain_arch = "arm-linux-androideabi-4.6"
     } else if (cpu_arch == "mipsel") {
@@ -85,6 +87,17 @@ gcc_toolchain("x86") {
   toolchain_os = "android"
 }
 
+gcc_toolchain("x64") {
+  prefix = "$android_ndk_root/toolchains/x86_64-4.8/prebuilt/$build_os-$android_host_arch/bin/x86_64-linux-android-"
+  cc  = prefix + "gcc"
+  cxx = prefix + "g++"
+  ar  = prefix + "ar"
+  ld  = cxx
+
+  toolchain_cpu_arch = "x64"
+  toolchain_os = "android"
+}
+
 gcc_toolchain("arm") {
   prefix = "$android_ndk_root/toolchains/arm-linux-androideabi-4.6/prebuilt/$build_os-$android_host_arch/bin/arm-linux-androideabi-"
   cc  = prefix + "gcc"
-- 
1.8.3.2

