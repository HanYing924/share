From 40ce260de1b420ea540968996855244b3d4cc06a Mon Sep 17 00:00:00 2001
From: Yang Gu <yang.gu@intel.com>
Date: Fri, 21 Feb 2014 22:01:42 +0800
Subject: [PATCH 02/11] jni fixes in net/ for Android x64

---
 net/android/java/src/org/chromium/net/AndroidKeyStore.java        | 2 +-
 net/android/java/src/org/chromium/net/DefaultAndroidKeyStore.java | 6 +++---
 net/android/java/src/org/chromium/net/RemoteAndroidKeyStore.java  | 2 +-
 net/android/keystore.cc                                           | 2 +-
 4 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/net/android/java/src/org/chromium/net/AndroidKeyStore.java b/net/android/java/src/org/chromium/net/AndroidKeyStore.java
index 6db0d0a..8c85a47 100644
--- a/net/android/java/src/org/chromium/net/AndroidKeyStore.java
+++ b/net/android/java/src/org/chromium/net/AndroidKeyStore.java
@@ -135,7 +135,7 @@ public interface AndroidKeyStore {
      * @return The EVP_PKEY handle, as a 32-bit integer (0 if not available)
      */
     @CalledByNative
-    int getOpenSSLHandleForPrivateKey(AndroidPrivateKey key);
+    long getOpenSSLHandleForPrivateKey(AndroidPrivateKey key);
 
     /**
      * Called when the native OpenSSL engine no longer needs access to the underlying key.
diff --git a/net/android/java/src/org/chromium/net/DefaultAndroidKeyStore.java b/net/android/java/src/org/chromium/net/DefaultAndroidKeyStore.java
index 5232e46..cc61657 100644
--- a/net/android/java/src/org/chromium/net/DefaultAndroidKeyStore.java
+++ b/net/android/java/src/org/chromium/net/DefaultAndroidKeyStore.java
@@ -143,7 +143,7 @@ public class DefaultAndroidKeyStore implements AndroidKeyStore {
     }
 
     @Override
-    public int getOpenSSLHandleForPrivateKey(AndroidPrivateKey key) {
+    public long getOpenSSLHandleForPrivateKey(AndroidPrivateKey key) {
         PrivateKey javaKey = ((DefaultAndroidPrivateKey) key).getJavaKey();
         // Sanity checks
         if (javaKey == null) {
@@ -207,9 +207,9 @@ public class DefaultAndroidKeyStore implements AndroidKeyStore {
                 return 0;
             }
             getPkeyContext.setAccessible(true);
-            int evp_pkey = 0;
+            long evp_pkey = 0;
             try {
-                evp_pkey = (Integer) getPkeyContext.invoke(opensslKey);
+                evp_pkey = (Long) getPkeyContext.invoke(opensslKey);
             } finally {
                 getPkeyContext.setAccessible(false);
             }
diff --git a/net/android/java/src/org/chromium/net/RemoteAndroidKeyStore.java b/net/android/java/src/org/chromium/net/RemoteAndroidKeyStore.java
index e979036..96037f8 100644
--- a/net/android/java/src/org/chromium/net/RemoteAndroidKeyStore.java
+++ b/net/android/java/src/org/chromium/net/RemoteAndroidKeyStore.java
@@ -110,7 +110,7 @@ public class RemoteAndroidKeyStore implements AndroidKeyStore {
     }
 
     @Override
-    public int getOpenSSLHandleForPrivateKey(AndroidPrivateKey privateKey) {
+    public long getOpenSSLHandleForPrivateKey(AndroidPrivateKey privateKey) {
         // This should not be called as it's only for older versions of Android.
         assert false;
         return 0;
diff --git a/net/android/keystore.cc b/net/android/keystore.cc
index cefd4f4..de36c95 100644
--- a/net/android/keystore.cc
+++ b/net/android/keystore.cc
@@ -134,7 +134,7 @@ EVP_PKEY* GetOpenSSLSystemHandleForPrivateKey(jobject private_key_ref) {
   // Given that this routine shall only be called on Android < 4.2,
   // this won't be a problem in the far future (e.g. when Android gets
   // ported to 64-bit environments, if ever).
-  int pkey = Java_AndroidKeyStore_getOpenSSLHandleForPrivateKey(
+  long pkey = Java_AndroidKeyStore_getOpenSSLHandleForPrivateKey(
       env,
       GetKeyStore(private_key_ref).obj(),
       private_key_ref);
-- 
1.8.3.2

